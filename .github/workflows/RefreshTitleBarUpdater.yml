name: RefreshTitleBarUpdater

on:
  schedule:
    - cron: '0 6 * * *'                 # S'exÃ©cute tous les jours Ã  6h du matin
  workflow_dispatch:                      # Permet de lancer le workflow manuellement depuis l'onglet Actions

jobs:
  sync-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Donne la permission de pousser des commits

    steps:
      # 1. RÃ©cupÃ©rer votre dÃ©pÃ´t
      - name: Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. TÃ©lÃ©charger le fichier CSS depuis la source
      - name: TÃ©lÃ©charger le fichier CSS source
        run: |
          curl -s -o /tmp/desktop.css \
            "https://raw.githubusercontent.com/G0d0fninjas/visual-refresh-compact-title-bar/refs/heads/main/desktop.css"
          echo "Fichier tÃ©lÃ©chargÃ©. Ligne avant modification :"
          grep -n "vr-header-snippet-button-padding: 0;" /tmp/desktop.css || true

      # 3. Appliquer votre modification
      - name: Appliquer la modification personnelle
        run: |
          # Cette commande remplace exactement "0;" par "8px;" pour la propriÃ©tÃ© spÃ©cifique
          sed -i 's|vr-header-snippet-button-padding: 0;|vr-header-snippet-button-padding: 8px;|' /tmp/desktop.css
          
          # VÃ©rification que la modification a fonctionnÃ©
          echo "Ligne aprÃ¨s modification :"
          grep -n "vr-header-snippet-button-padding: 8px;" /tmp/desktop.css || echo "La ligne modifiÃ©e n'a pas Ã©tÃ© trouvÃ©e."
          
          # VÃ©rification de sÃ©curitÃ© : on s'assure que l'ancienne valeur '0' n'est plus prÃ©sente pour cette propriÃ©tÃ©
          if grep -n "vr-header-snippet-button-padding: 0;" /tmp/desktop.css; then
            echo "âš ï¸ ATTENTION : L'ancien motif 'vr-header-snippet-button-padding: 0;' est toujours prÃ©sent. La modification n'a peut-Ãªtre pas fonctionnÃ©."
            # Ne pas forcÃ©ment Ã©chouer, mais prÃ©venir dans les logs
          else
            echo "âœ… SuccÃ¨s : L'ancienne valeur '0' a bien Ã©tÃ© remplacÃ©e par '8px'."
          fi

      # 4. VÃ©rifier les changements avant de copier
      - name: DÃ©tecter les changements
        id: detect-change
        run: |
          # Initialisation
          echo "has_changes=false" >> $GITHUB_OUTPUT
          
          # Cas 1 : Le fichier n'existe pas du tout dans le dÃ©pÃ´t -> changement
          if [ ! -f "RefreshTitleBar.css" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ†• Fichier Ã  crÃ©er (il n'existe pas encore)."
          else
            # Cas 2 : Le fichier existe, on compare son contenu avec la nouvelle version
            if ! diff -q "RefreshTitleBar.css" /tmp/desktop.css > /dev/null; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Changements dÃ©tectÃ©s dans le fichier existant !"
              diff -u "RefreshTitleBar.css" /tmp/desktop.css | head -10
            else
              echo "âœ… Aucun changement nÃ©cessaire."
            fi
          fi

      # 5. Copier le fichier modifiÃ© seulement si changement dÃ©tectÃ©
      - name: Copier le fichier
        if: steps.detect-change.outputs.has_changes == 'true'
        run: |
          cp /tmp/desktop.css RefreshTitleBar.css
          echo "âœ… Fichier 'RefreshTitleBar.css' crÃ©Ã©/mis Ã  jour."

      # 6. Committer et pousser seulement si changement
      - name: Committer et pousser
        if: steps.detect-change.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add RefreshTitleBar.css
          git commit -m "ðŸ”„ CSS auto-sync: MÃ j depuis la source + padding 0â†’8px
          
          Synchronisation automatique depuis :
          https://github.com/G0d0fninjas/visual-refresh-compact-title-bar
          
          Modification appliquÃ©e :
          - --vr-header-snippet-button-padding: 0; â†’ 8px;
          
          Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push origin main
          echo "âœ… Changements poussÃ©s sur 'main'."
